---
title: "OBER project BODAC filters and water"
author: "Pieter van Veelen"
date: "5/21/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen=999)
```

## R Markdown

Analysis of microbial communities in BODAC filters and backwash water. Evaluate the effects of different DNA extraction methods. Pre-filters and polishing filters are referred to as BODAC1 and BODAC2, respectively, in the manuscript text and in figures (adjusted using Illustrator pre-submission).

### Set parameters and import data
```{r library install, message=F, echo=T, eval=T, warning=T, include=F, cache=T}

# install packages
library(devtools)
#install.packages("data.table", type = "binary")
if (!requireNamespace("devtools", quietly= TRUE)){install.packages("devtools")}
devtools::install_github("jbisanz/qiime2R")
if (!requireNamespace("devtools", quietly= TRUE)){install.packages("tidyverse")}
if (!requireNamespace("devtools", quietly= TRUE)){install.packages("openxlsx")}
if (!requireNamespace("pairwiseAdonis", quietly = TRUE)){devtools::install_github("pmartinezarbizu/pairwiseAdonis/pairwiseAdonis")}
#devtools::install_github("adw96/breakaway") 
#devtools::install_github("adw96/DivNet")
if (!requireNamespace("ANCOMBC", quietly = TRUE)){BiocManager::install("ANCOMBC")}
if (!requireNamespace("gitcreds", quietly = TRUE)){install.packages("gitcreds")}

```

```{r project organization, message=F, echo=T, eval=T, warning=T, include=F, cache=T}

# create directories
if(!dir.exists("./figures")){dir.create("./figures")}
if(!dir.exists("./output_data")){dir.create("./output_data")} 

```


```{r library loading, message=F, echo=T, eval=T, warning=T, include=F, cache=F}

## load required packages
library(gitcreds)
library(phyloseq)
library(qiime2R)
library(tidyverse)
library(magrittr)
library(devtools)
library(qiime2R)
library(here)
library(openxlsx)
library(ape)
library(vegan)
library(ggtext)
library(cowplot)
library(RColorBrewer)
library(broom)
library(ANCOMBC)
library(pairwiseAdonis)

```

```{r import data, message=F, echo=T, eval=T, warning=T, include=F, cache=F}

#creating phyloseq objects with 
physeq<-qza_to_phyloseq(features = "input_data/OBER_Q12946_16S_515F926R_20201113_table.qza",
                        tree = "input_data/OBER_Q12946_16S_515F926R_20201113_rooted-tree.qza",
                        taxonomy = "input_data/OBER_Q12946_16S_515F926R_20201113_taxonomy_NB_classifier_SILVA_132_99_16S_515F-926R_QIIME2-2019.10.qza",
                        metadata = "input_data/OBER_Q12946_16S_515F926R_20201113@metadata_complete.txt")

colnames(sample_data(physeq))
sample_data(physeq)$combined <- factor(paste0(sample_data(physeq)$Filter_type, "-", sample_data(physeq)$Sample_type, "-", sample_data(physeq)$Time))
```

```{r clean phylogeny, message=F, echo=F, eval=T, warning=T, include=F, cache=F}
### resolve phylogenetic tree ###

# evaluate tree topology
is.binary.tree(phy_tree(physeq)) # if FALSE --> polychotomy present (node has more than 2 tips)
#TRUE

# if FALSE:
# resolve polychotomous nodes
phy_tree_resolved <- multi2di(phy_tree(physeq))
is.binary.tree(phy_tree_resolved)
# create new phy_tree
tree2 <- phy_tree_resolved

# subset_taxa(phy_tree_resolved, Kingdom ==  "Bacteria")

# merge new phy_tree object with sample_data and otu_table into new phyloseq object
psdata_OBER <- merge_phyloseq(otu_table(physeq), sample_data(physeq), tax_table(physeq), tree2)
rank_names(psdata_OBER)
```

#### cleaning taxonomy
```{r clean taxanomy, message=F, echo=F, eval=T, warning=T, include=F, cache=F}
### remove Archaea, Chloroplast and Mitochondia and unassigned Kingdom
#View(tax_table(psdata_OBER)@.Data) # no of the groups below present (21 ASVs in total)
#physeq1 <- subset_taxa(psdata_OBER, Kingdom == "D_0__Bacteria") # retain Archaea
#physeq2 <- subset_taxa(psdata_OBER, Phylum == "Chloroplast") # none found
#physeq3 <- subset_taxa(psdata_OBER, Class == "Chloroplast") # none found
physeq1 <- subset_taxa(psdata_OBER, Order != "Chloroplast") # dropped 3 ASVs
physeq2 <- subset_taxa(physeq1, Family != "Mitochondria") # dropped 191 ASVs

## clean taxonomy tags with no information
# specify NA taxon name tags to last known taxon names
tax.clean <- data.frame(tax_table(physeq2))
#tax.clean <- data.frame(tax.clean)
mode(tax.clean)
str(tax.clean)


# change tags into characters
tax.clean2 <- tax.clean
tax.clean2$Kingdom <- as.character(tax.clean2$Kingdom)
tax.clean2$Phylum <- as.character(tax.clean2$Phylum)
tax.clean2$Class <- as.character(tax.clean2$Class)
tax.clean2$Order <- as.character(tax.clean2$Order)
tax.clean2$Family <- as.character(tax.clean2$Family)
tax.clean2$Genus <- as.character(tax.clean2$Genus)
tax.clean2$Species <- as.character(tax.clean2$Species)
str(tax.clean2)


tax.clean = tax.clean %>% mutate_all(funs(str_replace(., "Ambiguous_taxa", "")))
tax.clean = tax.clean %>% mutate_all(funs(str_replace(., "metagenome", "")))
tax.clean = tax.clean %>% mutate_all(funs(str_replace(., "uncultured archeaon", "")))
tax.clean = tax.clean %>% mutate_all(funs(str_replace(., "uncultured bacterium", "")))
tax.clean = tax.clean %>% mutate_all(funs(str_replace(., "uncultured sludge bacterium", "")))
tax.clean = tax.clean %>% mutate_all(funs(str_replace(., "Unclassified bacterium", "")))
tax.clean = tax.clean %>% mutate_all(funs(str_replace(., "unclassified bacterium", "")))
tax.clean[is.na(tax.clean)] <- ""


# function replace name tags from [https://github.com/joey711/phyloseq/issues/850]
for (i in 1:nrow(tax.clean)){
  if (tax.clean[i,2] == ""){
    Kingdom <- paste("Kingdom_", tax.clean[i,1], sep = "")
    tax.clean[i, 2:7] <- Kingdom
  } else if (tax.clean[i,3] == ""){
    Phylum <- paste("Phylum_", tax.clean[i,2], sep = "")
    tax.clean[i, 3:7] <- Phylum
  } else if (tax.clean[i,4] == ""){
    Class <- paste("Class_", tax.clean[i,3], sep = "")
    tax.clean[i, 4:7] <- Class
  } else if (tax.clean[i,5] == ""){
    Order <- paste("Order_", tax.clean[i,4], sep = "")
    tax.clean[i, 5:7] <- Order
  } else if (tax.clean[i,6] == ""){
    Family <- paste("Family_", tax.clean[i,5], sep = "")
    tax.clean[i, 6:7] <- Family
  } else if (tax.clean[i,7] == ""){
    tax.clean$Species[i] <- paste("Genus_",tax.clean$Genus[i], sep = "_")
  }
}

psdata_newTaxtab <- psdata_OBER
tax_table(psdata_newTaxtab) <- as.matrix(tax.clean)
tax_table(psdata_newTaxtab)

# put cleaned tax_table into phyloseq object
tax_table(physeq2) <- as.matrix(tax.clean)

psdata_OBER <- physeq2

```

#### Analysis of DNA concentrations
```{r DNA concentration and purity data import, message=F, echo=F, eval=T, warning=F, include=F, cache=F}

dna_data <- read.table("input_data/OBER_DNA_conc_purity_data.txt", header = T, sep = "\t", dec = ".") %>% as_tibble()
metadata_ps <- data.frame(sample_data(psdata_OBER)) %>% rownames_to_column(var = "SampleID") %>% as_tibble()
metadata_dna_ <- inner_join(dna_data, metadata_ps, by = "SampleID")

# metadata_dna %>% 
#   pivot_longer(c(unpurified, purified), names_to = "Purification", values_to = "DNA_conc_ng_ul") %>% 
#   mutate(dna_amount_ng = ifelse(Purification == "unpurified", DNA_conc_ng_ul*30, 
#                                 DNA_conc_ng_ul*20)) %>% 
#   ggplot(aes(x = combined, y = dna_amount_ng)) +
#   geom_point(aes(color = Protocol), position = position_jitterdodge(0.2), pch=21) +
#   facet_wrap(~Purification + Filter_type) +
#   theme_classic() +
#   theme(axis.text.x = element_text(angle = 90, hjust = 0))
#   theme(axis.text.x = element_text(angle = 90, hjust = 0))

# reshape metadata
metadata_dna = 
metadata_dna_ %>% 
  pivot_longer(c(unpurified, purified), 
               names_to = "Purification", 
               values_to = "DNA_conc_ng_ul") %>% 
  pivot_longer(c(unpurified_260_280, unpurified_260_230, purified_260_280, purified_260_230), 
               names_to = "group_purification", 
               values_to = "Absorbance_ratio") %>% 
  #select(SampleID, Purification, DNA_conc_ng_ul, group_purification, Absorbance_ratio) %>% 
  separate(col = group_purification, sep = "_", into = c("purif_state","waves_1","waves_2")) %>% 
  mutate(waves = paste0("absorb_", waves_1, "_", waves_2)) %>% select(-waves_1, -waves_2) %>% 
  filter(Filter_type != "Blank") %>% 
  mutate(Filter_type = fct_relevel(Filter_type, "Pre-filter"),
         Filter_type = fct_recode(Filter_type, BODAC1 = "Pre-filter", BODAC2 = "Polishing_filter"))


```



```{r plot and stats DNA purity, message=F, echo=T, eval=T, warning=F, include=T, cache=F}

purity_260_230 =
metadata_dna %>% 
  filter(Purification == purif_state,
         waves == "absorb_260_230") %>% 
  mutate(Purification = fct_relevel(Purification, c("unpurified", "purified"))) %>% 
  #pivot_wider(names_from = waves, values_from = Absorbance_ratio)
  #filter(Purification == "unpurified") %>% 
  ggplot(aes(x = Sample_type, y = Absorbance_ratio)) +
  geom_abline(intercept = 2.1, slope =0, size=3, color = "grey80", alpha = 0.7) +
  geom_point(aes(color = Protocol, shape = Filter_type),
             position = position_jitterdodge(0.2), show.legend = T, size = 2) +
  scale_color_manual(values = c(brewer.pal(2, "Dark2"))) +
  labs(y = "Absorbance ratio\n260/230 nm", x = NULL) +
  guides(colour = guide_legend(title.position = "top"),
         size = guide_legend(title.position = "top")) +
  #stat_summary(fun = median, pch = 21) +
  facet_wrap(nrow = 2, ncol = 2, ~ Purification, strip.position = "top") +
  theme_classic() +
  theme(axis.text.x = element_markdown(),
        legend.text = element_markdown(),
        legend.key.size = unit(10, "pt"),
        strip.placement = "outer", 
        strip.background = element_blank(),
        strip.text.x = element_text(size = 14, face = "bold"),
        panel.spacing = unit(0.2, "lines"))
  #theme(legend.position = "bottom") +
  #theme(axis.text.x = element_text(angle = 90, hjust=1))


purity_260_280 =
metadata_dna %>% 
  filter(Purification == purif_state,
         waves == "absorb_260_280") %>% 
  mutate(Purification = fct_relevel(Purification, c("unpurified", "purified"))) %>% 
  #pivot_wider(names_from = waves, values_from = Absorbance_ratio)
  #filter(Purification == "unpurified") %>% 
  ggplot(aes(x = Sample_type, y = Absorbance_ratio)) +
  geom_abline(intercept = 1.8, slope =0, size=1, color = "grey80", alpha = 0.7) +
  geom_point(aes(color = Protocol, shape = Filter_type),
             position = position_jitterdodge(0.2), show.legend = T, size = 2) +
  scale_color_manual(values = c(brewer.pal(2, "Dark2"))) +
  #stat_summary(fun = median, pch = 21) +
  facet_wrap(nrow = 2, ncol = 2, ~ Purification, strip.position = "top") +
  labs(y = "Absorbance ratio\n260/280 nm", x = NULL) +
  guides(colour = guide_legend(title.position = "top"),
         size = guide_legend(title.position = "top")) +
  theme_classic() +
  theme(axis.text.x = element_markdown(),
        legend.text = element_markdown(),
        legend.key.size = unit(10, "pt"),
        strip.text = element_blank(), # redundant in B
        strip.placement = "outer", 
        strip.background = element_blank(),
        #strip.text.x = element_text(size = 14, face = "bold"),
        panel.spacing = unit(0.2, "lines"))
  #theme(legend.position = "bottom") +
  #theme(axis.text.x = element_text(angle = 90, hjust=1))
 
# extract plots without legend 
purity_plots = plot_grid(purity_260_230 + theme(legend.position = "none"), 
                         purity_260_280 + theme(legend.position = "none"), 
                         labels  = c("A", "B"), 
                         nrow = 2,
                         align = "hv")  

# extract legend
legend_purity <- get_legend(purity_260_280 + guides(color = guide_legend(ncol = 1), 
                                             shape = guide_legend(ncol = 1)) +
                            theme(legend.position = "bottom",
                                  legend.direction = "vertical"))

# shape figure with plots and legend
purity_fig <- plot_grid(purity_plots, legend_purity, nrow=2, rel_heights = c(6, 1))
purity_fig

# save figure
ggsave(plot = purity_fig, filename = "figures/Fig_1_OBER_DNA_purity.pdf", width = 6, height = 5)
 
```

#### Analysis of DNA concentrations
```{r plot DNA concentrations, message=F, echo=T, eval=T, warning=T, include=T, cache=F,fig.width=5, fig.height=10}

# plot DNA concentration unpurified only
unpurified_yield <- 
metadata_dna %>% 
  mutate(dna_amount_ng = ifelse(Purification == "unpurified", DNA_conc_ng_ul*30, 
                                DNA_conc_ng_ul*20)) %>% 
  filter(Purification == "unpurified") %>% 
  select(SampleID, Sample_type, Filter_type, Protocol, dna_amount_ng) %>% 
  distinct() %>% 
  ggplot(aes(x = Protocol, y = dna_amount_ng/1000, color = Protocol, fill = Protocol)) +
  stat_summary(fun = median, geom = "bar", alpha = 0.5) +
  geom_point(size = 2, position = position_jitterdodge(0.2), show.legend = F) +
  scale_color_manual(values = c(brewer.pal(2, "Dark2"))) +
  scale_fill_manual(values = c(brewer.pal(2, "Dark2"))) +
  facet_grid(~Sample_type + Filter_type) +
  theme_classic() +
  labs(y = expression(paste("DNA yield (",mu,"g) before purification")), x = NULL) +
  #theme(legend.position = "bottom") +
  #ggtitle("DNA yield before purification") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

# plot DNA concentration purified only
purified_yield <- 
metadata_dna %>% 
  mutate(dna_amount_ng = ifelse(Purification == "unpurified", DNA_conc_ng_ul*30, 
                                DNA_conc_ng_ul*20)) %>% 
  filter(Purification == "purified") %>% 
  select(SampleID, Sample_type, Filter_type, Protocol, dna_amount_ng) %>% 
  distinct() %>% 
  ggplot(aes(x = Protocol, y = dna_amount_ng/1000, color = Protocol, fill=Protocol)) +
  stat_summary(fun = median, geom = "bar", alpha = 0.5) +
  geom_point(size = 2, position = position_jitterdodge(0.2), show.legend = F) +
  scale_color_manual(values = c(brewer.pal(2, "Dark2"))) +
  scale_fill_manual(values = c(brewer.pal(2, "Dark2"))) +
  facet_grid(~Sample_type + Filter_type) +
  theme_classic() +
  labs(y = expression(paste("DNA yield (",mu,"g) after purification")), x = NULL) +
  #theme(legend.position = "bottom") +
  #ggtitle("DNA yield after purification") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


# DNA yield plot
plot_fig <- cowplot::plot_grid(unpurified_yield + theme(legend.position = "none"), 
                               purified_yield + theme(legend.position = "none"),
                               get_legend(unpurified_yield + 
                                            theme(legend.position = "bottom",
                                                  legend.direction = "horizontal")), 
                               labels = c("A", "B"),
                               nrow = 3, 
                               rel_heights = c(1, 1, 0.2))
# show plot
plot_fig

# save plot
ggsave(plot_fig, filename = "figures/Figure_2_DNA_quantity.pdf", width = 4, height = 9)

```

```{r stats DNA concentrations, message=F, echo=T, eval=T, warning=T, include=T, cache=F,fig.width=4, fig.height=4}

# tabulate loss
metadata_dna_ %>%
  mutate(loss_ng = (purified*20)-(unpurified*30)) %>%
  group_by(Protocol, Sample_type, Filter_type) %>%
  summarize(median_hilow(loss_ng))

# plot loss
metadata_dna_ %>%
  mutate(loss_ng = (purified*20)-(unpurified*30)) %>%
  ggplot(aes(y = loss_ng, x = Protocol, color = Sample_type)) +
  geom_point() +
  facet_wrap(~Filter_type) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

# statistics
# unpurified
# water only
metadata_dna %>% 
  mutate(dna_amount_ng = ifelse(Purification == "unpurified", DNA_conc_ng_ul*30, 
                                DNA_conc_ng_ul*20)) %>% 
  select(SampleID, Purification, Sample_type, Filter_type, Protocol, dna_amount_ng) %>% 
  distinct() %>% 
  filter(Purification == "unpurified",
         Sample_type == "Water") %>% 
  with(kruskal.test(dna_amount_ng ~ Protocol)) 

# granules
metadata_dna %>% 
  mutate(dna_amount_ng = ifelse(Purification == "unpurified", DNA_conc_ng_ul*30, 
                                DNA_conc_ng_ul*20)) %>% 
  select(SampleID, Purification, Sample_type, Filter_type, Protocol, dna_amount_ng) %>% 
  distinct() %>% 
  filter(Purification == "unpurified",
         Sample_type == "Granules") %>% 
  with(kruskal.test(dna_amount_ng ~ Protocol)) 

#purified
# water only
metadata_dna %>% 
  mutate(dna_amount_ng = ifelse(Purification == "unpurified", DNA_conc_ng_ul*30, 
                                DNA_conc_ng_ul*20)) %>% 
  select(SampleID, Purification, Sample_type, Filter_type, Protocol, dna_amount_ng) %>% 
  distinct() %>% 
  filter(Purification == "purified",
         Sample_type == "Water") %>% 
  with(kruskal.test(dna_amount_ng ~ Protocol)) 

# granules only
metadata_dna %>% 
  mutate(dna_amount_ng = ifelse(Purification == "unpurified", DNA_conc_ng_ul*30, 
                                DNA_conc_ng_ul*20)) %>% 
  select(SampleID, Purification, Sample_type, Filter_type, Protocol, dna_amount_ng) %>% 
  distinct() %>% 
  filter(Purification == "purified",
         Sample_type == "Granules") %>% 
  with(kruskal.test(dna_amount_ng ~ Protocol)) 

```
```{r DNA purity ratios nanodrop, message=F, echo=T, eval=T, warning=T, include=T, cache=F}

### read in new purity data by OBER
# Test for differences in purity between purified and unpurified samples stratified by granules and water, and without blanks.


```



#### calculate rarefaction curves using amp_rarecurve.r
```{r abundance filter, message=F, echo=T, eval=T, warning=T, include=T, cache=F}

# full dataset
psdata_OBER
psdata_OBER <- subset_samples(psdata_OBER, Filter_type != "Blank")

# average and variation in coverage
mean(sample_sums(psdata_OBER)) # = 69797.76
summary(sample_sums(psdata_OBER))
sum(sample_sums(psdata_OBER))

# number of reads in Blank (#538)
sample_sums(subset_samples(physeq2, Filter_type == "Blank"))

# relative abundance data
psdata_OBER_rel <- transform_sample_counts(psdata_OBER, fun = function(x) x/sum(x)) # 3009 taxa (100% abundance)

# abundance filter at (0.01%, 0.1% 0.5%)
psdata_OBER_0.01pct <- prune_taxa(taxa_sums(psdata_OBER_rel) > 0.0001, psdata_OBER) #2610 (99.94% abundance)
psdata_OBER_0.1pct <- prune_taxa(taxa_sums(psdata_OBER_rel) > 0.001, psdata_OBER) #1615 (98.73% abundance)
psdata_OBER_0.5pct <- prune_taxa(taxa_sums(psdata_OBER_rel) > 0.005, psdata_OBER) #2610 (93.07% abundance)

### choice to continue downstream analysis with abundance filter that retains ASVs with at least 0.1% of total read abundance.
psdata_OBER_unfiltered <- psdata_OBER # save unfiltered data
psdata_OBER <- psdata_OBER_0.1pct # overwrite psdata_OBER for abundance filtered data

# reformat metadata
metadata <- data.frame(sample_data(psdata_OBER), stringsAsFactors = T)
metadata$Sample_type <- as.factor(metadata$Sample_type)
metadata$Filter_type <- as.factor(metadata$Filter_type)
metadata$Time <- as.factor(metadata$Time)
metadata$Protocol <- as.factor(metadata$Protocol)

```

```{r rarefaction curves, message=F, echo=T, eval=T, warning=T, include=T, cache=F}
# alpha rarefaction curve
source("scripts/ampvis2_internals.r")
source("scripts/amp_rankabundance.r")
source("scripts/amp_rarecurve.r")

# show plot
amp_rarecurve(psdata_OBER_unfiltered, color = "combined", legend.position = "bottomright")

# save plot
pdf("figures/OBER_proj1_BODAC_rarefaction_curves.pdf", useDingbats = F, width = 6, height = 4)
amp_rarecurve(psdata_OBER_unfiltered, color = "combined", legend.position = "bottomright")
dev.off()

#amp_rarecurve(psdata_OBER, color = "combined", legend.position = "bottomright")
#amp_rarecurve(psdata_OBER, color = "Protocol", legend.position = "bottomright")

# difference in sample coverage (5.75)
max(sample_sums(psdata_OBER)/min(sample_sums(psdata_OBER)))


```

```{r avg_rarefy psdata, message=F, echo=T, eval=T, warning=T, include=T, cache=F}

# summary statistics of dataset
summary(sample_sums(psdata_OBER)) %>% 
  enframe(name = "statistic", value = "read count") %>% 
  as_tibble() %>% kableExtra::kbl(caption = "summary statistics of sequence data set", centering = T, align = "l") %>% kableExtra::kable_classic()


# rarefy to 16865
  # create subset frequency matrix
  OBER_matrix <- as.matrix(t(otu_table(psdata_OBER)))
  
  # determine minimal sampling depth
  min_sample <- min(sample_sums(psdata_OBER))
  
  # rarefaction taking mean of 100 iterations
  set.seed(711)
  # OBER_rare16865 <- avgdist(OBER_matrix, d_method="bray", sample = min_sample, iterations = 100)
  # not using this: we also aim to calculate UniFrac
  source("scripts/avgrarefy.r")
  OBER_rare16865_table = avgrarefy(x=OBER_matrix, sample = min_sample, iterations = 100, seed = 711)


# create phyloseq object with rarefied data  
psdata_OBER_rare <- psdata_OBER
otu_rare = otu_table(data.frame(t(OBER_rare16865_table)), taxa_are_rows = TRUE)
otu_table(psdata_OBER_rare) <- otu_rare

```

```{r plot alpha diversity no_rare, message=F, echo=F, eval=F, warning=F, include=F, cache=F}

# calculate alpha diversity: richness & Shannon

# not rarefied
alpha <- estimate_richness(psdata_OBER, measures = c("Chao1", "Shannon"))
alpha$sampleID <- row.names(alpha)
metadata$sampleID <- sample_names(psdata_OBER)
alpha <- left_join(metadata, alpha, by = "sampleID")

# plot alpha diversity
Chao1 <- alpha %>% 
  ggplot(aes(x=combined, y=Chao1, color = combined, shape = Protocol)) +
  geom_jitter(aes(group = Protocol), position = position_dodge(0.3), show.legend = T) +
  #geom_bar(stat="identity") + 
  theme(axis.text.x = element_text(angle = 90, hjust = 0)) +
  theme(legend.text = element_markdown(),
        legend.key.size = unit(7, "pt"),
        axis.ticks.x = element_blank(), 
        strip.background = element_blank(),
        strip.placement = "outside",
        legend.position = "bottom")
Shannon <- alpha %>% 
  ggplot(aes(x=combined, y=Shannon, color = combined, shape = Protocol)) +
  geom_jitter(aes(group = Protocol), position = position_dodge(0.3), show.legend = T) +
  #geom_bar(stat="identity") + 
  theme(axis.text.x = element_text(angle = 90, hjust = 0)) +
  theme(legend.text = element_markdown(),
        legend.key.size = unit(7, "pt"),
        axis.ticks.x = element_blank(), 
        strip.background = element_blank(),
        strip.placement = "outside",
        legend.position = "bottom")

alpha_div = plot_grid(Chao1, Shannon, labels  = c("A", "B"), ncol = 2)
ggsave(alpha_div, filename = "figures/plot_alpha_div_OBER.pdf", width = 8, height = 6)


## rarefied to 16865

alpha <- estimate_richness(psdata_OBER, measures = c("Chao1", "Shannon"))
alpha$sampleID <- row.names(alpha)
metadata$sampleID <- sample_names(psdata_OBER)
alpha <- left_join(metadata, alpha, by = "sampleID")

# plot alpha diversity
Chao1 <- alpha %>% 
  ggplot(aes(x=combined, y=Chao1, color = combined, shape = Protocol)) +
  geom_jitter(aes(group = Protocol), position = position_dodge(0.3), show.legend = T) +
  #geom_bar(stat="identity") + 
  theme(axis.text.x = element_text(angle = 90, hjust = 0)) +
  theme(legend.text = element_markdown(),
        legend.key.size = unit(7, "pt"),
        axis.ticks.x = element_blank(), 
        strip.background = element_blank(),
        strip.placement = "outside",
        legend.position = "bottom")
Shannon <- alpha %>% 
  ggplot(aes(x=combined, y=Shannon, color = combined, shape = Protocol)) +
  geom_jitter(aes(group = Protocol), position = position_dodge(0.3), show.legend = T) +
  #geom_bar(stat="identity") + 
  theme(axis.text.x = element_text(angle = 90, hjust = 0)) +
  theme(legend.text = element_markdown(),
        legend.key.size = unit(7, "pt"),
        axis.ticks.x = element_blank(), 
        strip.background = element_blank(),
        strip.placement = "outside",
        legend.position = "bottom")

# compile plot
alpha_div = plot_grid(Chao1, Shannon, labels  = c("A", "B"), ncol = 2)
# show plot
alpha_div
# save plot
ggsave(alpha_div, filename = "figures/plot_alpha_div_OBER.pdf", width = 8, height = 6)

```

```{r plot alpha diversity rare, message=F, echo=T, eval=T, warning=T, include=T, cache=F}

# calculate alpha diversity: richness & Shannon

# rarefied
alpha <- estimate_richness(psdata_OBER_rare, measures = c("Chao1", "Shannon"))
alpha$sampleID <- row.names(alpha)
metadata$sampleID <- sample_names(psdata_OBER_rare)
alpha <- left_join(metadata, alpha, by = "sampleID")
alpha <- alpha %>% mutate(combined = factor(combined, levels= 
                                c("Pre-filter-Granules-Before",
                                  "Pre-filter-Granules-After",
                                  "Polishing_filter-Granules-Before",
                                  "Polishing_filter-Granules-After",
                                  "Pre-filter-Water-NA",
                                  "Polishing_filter-Water-NA")))


alpha %>% 
  group_by(Sample_type, Filter_type, Time, Protocol) %>% 
  summarize(n())

alpha %>% 
  pull(combined) %>% levels()
  
# plot alpha diversity
Chao1 <- alpha %>% 
ggplot(aes(x=combined, y=Chao1, color = Protocol, shape = Protocol, fill = Protocol)) +
  stat_summary(fun = median, geom = "bar", alpha = 0.5, position = position_dodge2(0.7, preserve = "single"), width=0.9) +
  geom_point(size = 2, position = position_jitterdodge(0.2), show.legend = F) +
  scale_color_manual(values = c(brewer.pal(6, "Dark2"))) +
  scale_fill_manual(values = c(brewer.pal(6, "Dark2"))) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(legend.text = element_markdown(),
        legend.key.size = unit(7, "pt"),
        axis.ticks.x = element_blank(), 
        strip.background = element_blank(),
        strip.placement = "outside",
        legend.position = "bottom") 

Shannon <- alpha %>% 
ggplot(aes(x=combined, y=Shannon, color = Protocol, shape = Protocol, fill = Protocol)) +
  stat_summary(fun = median, geom = "bar", alpha = 0.5, position = position_dodge2(0.7, preserve = "single"), width=0.9) +
  geom_point(size = 2, position = position_jitterdodge(0.3), show.legend = F) +
  scale_color_manual(values = c(brewer.pal(6, "Dark2"))) +
  scale_fill_manual(values = c(brewer.pal(6, "Dark2"))) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  theme(legend.text = element_markdown(),
        legend.key.size = unit(7, "pt"),
        axis.ticks.x = element_blank(), 
        strip.background = element_blank(),
        strip.placement = "outside",
        legend.position = "bottom") 

# create plot
alpha_div_rare = plot_grid(Chao1, Shannon, labels  = c("A", "B"), ncol = 2)

# show plot
alpha_div_rare

# save plot
ggsave(alpha_div_rare, filename = "figures/plot_alpha_div_OBER_rare16865.pdf", width = 8, height = 6)


```

```{r Alpha diversity statistics, message=F, echo=T, eval=T, warning=F, include=T, cache=F, fig.height=8, fig.width=4}

# test for differences in richness and diversity among DNA extraction protocols and sample type
alpha %>% with(., lm(Chao1 ~ Filter_type + Sample_type + Protocol)) %>% 
  anova %>% 
  broom::tidy() %>% 
  kableExtra::kable(caption = "Chao1 richness  statistics", digits = 3) %>%  
  kableExtra::kable_classic()


alpha %>% with(., lm(Shannon ~ Filter_type + Sample_type + Protocol)) %>% 
  anova %>% 
  broom::tidy() %>% 
  kableExtra::kable(caption = "Shannon diversity statistics", digits = 3) %>%  
  kableExtra::kable_classic()

## BODAC 1 vs BODAC 2 (FastSpin only, before backwashing only)
# Chao1 pairwise
alpha %>% 
  filter(Protocol == "Fast_DNA",
         Time == "Before") %>% 
  with(., lm(Chao1 ~ Filter_type)) %>% 
  anova() %>% 
  broom::tidy() %>% 
  kableExtra::kable(caption = "Difference Chao1 richness between BODAC1 and BODAC2 before backwashing", digits = 3) %>%  kableExtra::kable_classic()

# shannon pairwise
alpha %>% 
  filter(Protocol == "Fast_DNA",
         Time == "Before") %>% 
  with(., lm(Shannon ~ Filter_type)) %>% 
  anova() %>% 
  broom::tidy() %>% 
  kableExtra::kable(caption = "Difference Shannon diversity between BODAC1 and BODAC2 before backwashing", digits = 3) %>%  kableExtra::kable_classic()


## Granule vs BW
# Chao1 pairwise
alpha %>% 
  filter(Protocol == "Fast_DNA") %>% 
  with(., lm(Chao1 ~ Sample_type)) %>% 
  anova() %>% 
  broom::tidy() %>% 
  kableExtra::kable(caption = "Difference Chao1 richness between granules and backwash water across BODAC 1 and 2", digits = 3) %>%  kableExtra::kable_classic()

# shannon pairwise
alpha %>% 
  filter(Protocol == "Fast_DNA") %>% 
  with(., lm(Shannon ~ Sample_type)) %>% 
  anova() %>% 
  broom::tidy() %>% 
  kableExtra::kable(caption = "Difference Shannon diversity between granules and backwash water across BODAC 1 and 2", digits = 3) %>%  kableExtra::kable_classic()


```

```{r total beta diversity rel_abund, message=F, echo=F, eval=F, warning=F, include=F, cache=F, fig.height=8, fig.width=4}

### Beta diversity analysis first
# input data  = psdata_OBER_rel

# ordination
PCoA_BC <- ordinate(psdata_OBER_rel, method = "PCoA", distance = "bray")
PCoA_Jac <- ordinate(psdata_OBER_rel, method = "PCoA", distance = "jaccard")
PCoA_uu <- ordinate(psdata_OBER_rel, method = "PCoA", distance = "uunifrac")
PCoA_wu <- ordinate(psdata_OBER_rel, method = "PCoA", distance = "wunifrac")

colnames(sample_data(psdata_OBER_rel))
plot_PCoA_BC <- plot_ordination(physeq = psdata_OBER_rel, 
                                ordination = PCoA_BC, 
                                type = "samples", axes = c(1,2), color = "combined", shape = "Protocol") + 
  scale_color_manual(values = c(brewer.pal(6, "Dark2"))) + 
  ggtitle("Bray Curtis")
plot_PCoA_Jac <- plot_ordination(physeq = psdata_OBER_rel, 
                                 ordination = PCoA_Jac, 
                                 type = "samples", axes = c(1,2), color = "combined", shape = "Protocol") + 
  scale_color_manual(values = c(brewer.pal(6, "Dark2"))) + 
  ggtitle("Jaccard")
plot_PCoA_uu <- plot_ordination(physeq = psdata_OBER_rel, 
                                ordination = PCoA_uu, 
                                type = "samples", axes = c(1,2), color = "combined", shape = "Protocol") + 
  scale_color_manual(values = c(brewer.pal(6, "Dark2"))) + 
  ggtitle("unweighted UniFrac")
plot_PCoA_wu <- plot_ordination(physeq = psdata_OBER_rel, 
                                ordination = PCoA_wu, 
                                type = "samples", axes = c(1,2), color = "combined", shape = "Protocol") + 
  scale_color_manual(values = c(brewer.pal(6, "Dark2"))) + 
  ggtitle("weighted UniFrac")

pdf("figures/plot_beta_diversity_OBER_proj1_BODAC_rel_abund.pdf", useDingbats = F, width = 7, height = 12)
gridExtra::grid.arrange(plot_PCoA_Jac, plot_PCoA_BC, plot_PCoA_uu, plot_PCoA_wu, nrow=4, ncol=1)
dev.off()

```

```{r total beta diversity rarefied, message=F, echo=T, eval=T, warning=T, include=T, cache=F, fig.height=7, fig.width=12}

### Beta diversity analysis first
# input data  = psdata_OBER_rare

# ordination
PCoA_BC <- ordinate(psdata_OBER_rare, method = "PCoA", distance = "bray")
PCoA_Jac <- ordinate(psdata_OBER_rare, method = "PCoA", distance = "jaccard")
PCoA_uu <- ordinate(psdata_OBER_rare, method = "PCoA", distance = "uunifrac")
PCoA_wu <- ordinate(psdata_OBER_rare, method = "PCoA", distance = "wunifrac")

colnames(sample_data(psdata_OBER_rare))
plot_PCoA_BC <- plot_ordination(physeq = psdata_OBER_rare, 
                                ordination = PCoA_BC, 
                                type = "samples", axes = c(1,2), color = "combined", shape = "Protocol") + 
  scale_color_manual(values = c(brewer.pal(6, "Dark2"))) + 
  ggtitle("Bray Curtis")
plot_PCoA_Jac <- plot_ordination(physeq = psdata_OBER_rare, 
                                 ordination = PCoA_Jac, 
                                 type = "samples", axes = c(1,2), color = "combined", shape = "Protocol") + 
  scale_color_manual(values = c(brewer.pal(6, "Dark2"))) + 
  ggtitle("Jaccard")
plot_PCoA_uu <- plot_ordination(physeq = psdata_OBER_rare, 
                                ordination = PCoA_uu, 
                                type = "samples", axes = c(1,2), color = "combined", shape = "Protocol") + 
  scale_color_manual(values = c(brewer.pal(6, "Dark2"))) + 
  ggtitle("unweighted UniFrac")
plot_PCoA_wu <- plot_ordination(physeq = psdata_OBER_rare, 
                                ordination = PCoA_wu, 
                                type = "samples", axes = c(1,2), color = "combined", shape = "Protocol") + 
  scale_color_manual(values = c(brewer.pal(6, "Dark2"))) + 
  ggtitle("weighted UniFrac")
# compile combined beta diversity
beta_plot = cowplot::plot_grid(plot_PCoA_Jac, plot_PCoA_BC, plot_PCoA_uu, plot_PCoA_wu, nrow=2, ncol=2)

cowplot::plot_grid(plot_PCoA_Jac, plot_PCoA_BC, plot_PCoA_uu, plot_PCoA_wu, nrow=4, ncol=1) %>% 
ggsave(., filename = "figures/plot_beta_diversity_OBER_proj1_BODAC_rare16865_v2.pdf", width = 5, height = 10)



```

### Beta diversity Statistics
```{r total beta diversity stats, message=F, echo=T, eval=T, warning=T, include=T, cache=F}

## PERMANOVA and betadisper on rarefied data
metadata2 <- data.frame(sample_data(subset_samples(psdata_OBER_rare, Filter_type != "Blank")), stringsAsFactors = T)


dist_bc <- distance(psdata_OBER_rare , "bray")
dist_jac <- distance(psdata_OBER_rare, "jaccard", binary=T)
dist_uu <- distance(psdata_OBER_rare,  "uunifrac")
dist_wu <- distance(psdata_OBER_rare,  "wunifrac")

# test model assumptions with vegan::betadisper

# create dummy variable that covers all groups
metadata2$dummy_betadisp <- factor(paste0(metadata2$combined, metadata2$Protocol))

betadisper_jac <- betadisper(dist_jac,metadata2$dummy_betadisp)
anova(betadisper_jac) %>% broom::tidy() %>% kableExtra::kbl(caption = "Dispersion Jaccard distance") %>% kableExtra::kable_minimal()     

betadisper_bc <- betadisper(dist_bc,metadata2$dummy_betadisp)
anova(betadisper_bc) %>% broom::tidy() %>% kableExtra::kbl(caption = "Dispersion Bray-Curtis dissimilarity") %>% kableExtra::kable_minimal()                                  

betadisper_uu <- betadisper(dist_uu,metadata2$dummy_betadisp)
anova(betadisper_uu) %>% broom::tidy() %>% kableExtra::kbl(caption = "Dispersion unweighted UniFrac") %>% kableExtra::kable_minimal()

betadisper_wu <- betadisper(dist_wu,metadata2$dummy_betadisp)
anova(betadisper_wu) %>% broom::tidy() %>% kableExtra::kbl(caption = "Dispersion weighted UniFrac") %>% kableExtra::kable_minimal()

## for all four beta diversity metrics no significant group differences were found in group dispersions (distance to centroid).



# PERMANOVA (permutational multivariate analysis of variance) with the 'adonis' function

adonis_jac <- adonis2(dist_jac ~ Filter_type + Sample_type + Protocol, permutations = 999, data = metadata2, by = "margin")
adonis_jac %>% broom::tidy() %>% kableExtra::kbl(caption = "Jaccard distance") %>% kableExtra::kable_minimal()

adonis_bc <- adonis2(dist_bc ~ Filter_type + Sample_type + Protocol, permutations = 999, data = metadata2, by = "margin")
adonis_bc %>% broom::tidy() %>% kableExtra::kbl(caption = "Bray-Curtis dissimilarity") %>% kableExtra::kable_minimal()                 

adonis_uu <- adonis2(dist_uu ~ Filter_type + Sample_type + Protocol, permutations = 999, data = metadata2, by = "margin")
adonis_uu %>% broom::tidy() %>% kableExtra::kbl(caption = "unweighted UniFrac") %>% kableExtra::kable_minimal()

adonis_wu <- adonis2(dist_wu ~ Filter_type + Sample_type + Protocol, permutations = 999, data = metadata2, by = "margin")
adonis_wu %>% broom::tidy() %>% kableExtra::kbl(caption = "weighted UniFrac") %>% kableExtra::kable_minimal()


```

Preliminary beta diversity analysis showed that DNA extraction protocol does not affect beta diversity estimates. However, backwash water had different microbial communities than granule samples, since sample type explained between 17% and 49% of variation, depending on whether the chosen distance metric takes into account ASV relative abundance and/or phylogenetic relationships. Filter type explains a lot of variation ranging from 18% to 42% of variation, again depending on the beta diversity metric.  All estimates are interpreted from distance-based redundancy analysis with adonis2 function from vegan, estimating marginal effects only (i.e. accounting for all other effects in the model). 

#### Difference between granule and backwash water microbial community composition across both filters

```{r backwashing beta diversity 2, message=F, echo=T, eval=T, warning=T, include=T, cache=F, fig.height=12, fig.width=7}

# Pairwise Permanova to detect pairwise differences between granules and backwash water

## subsetting by removing CTAB method
psdata_OBER_rare_FastDNA <- subset_samples(psdata_OBER_rare, Protocol == "Fast_DNA") #& Filter_type != "Pre-filter")
# prareiminary: needs to include sqrt transformation and wisconsin double standardisation as in plot
metadata2_FastDNA <- data.frame(sample_data(psdata_OBER_rare_FastDNA), stringsAsFactors = T)

# calculate distance matrices
dist_bc_FastDNA <- distance(psdata_OBER_rare_FastDNA, method = "bray")
dist_uu_FastDNA <- distance(psdata_OBER_rare_FastDNA, method = "uunifrac")

# calculate pairwise adonis
# bray
PA_FastDNA_bray <- pairwiseAdonis::pairwise.adonis(dist_bc_FastDNA, 
                                factors = metadata2_FastDNA$Sample_type, 
                                p.adjust.m = "fdr",
                                perm = 999) %>% tibble() %>% mutate(method = "Bray Curtis")
# uunifrac
PA_FastDNA_uu <- pairwiseAdonis::pairwise.adonis(dist_uu_FastDNA, 
                                factors = metadata2_FastDNA$Sample_type, 
                                p.adjust.m = "fdr",
                                perm = 999) %>% tibble() %>% mutate(method = "Unweighted UniFrac")



bind_rows(PA_FastDNA_bray, PA_FastDNA_uu) %>% 
  select(method, everything())%>% 
  kableExtra::kbl(caption = "Beta diversity pairwise differences between granules and backwash water across BODAC1 and 2") %>% 
  kableExtra::kable_minimal()

```


#### Effects of backwashing on granule microbial community composition performed after filtering out all water samples (FastSpin Only).

```{r granule beta diversity, message=F, echo=T, eval=T, warning=T, include=T, cache=F, fig.height=7, fig.width=12}


## subsetting by removing water samples
psdata_OBER_rare_noH2O <- subset_samples(psdata_OBER_rare, Filter_type != "Blank" & Sample_type != "Water" & Protocol == "Fast_DNA")
# prareiminary: needs to include sqrt transformation and wisconsin double standardisation as in plot
metadata2_noH2O <- data.frame(sample_data(psdata_OBER_rare_noH2O), stringsAsFactors = T)

# ordination
PCoA_BC_noH2O <- ordinate(psdata_OBER_rare_noH2O, method = "PCoA", distance = "bray")
PCoA_Jac_noH2O <- ordinate(psdata_OBER_rare_noH2O, method = "PCoA", distance = "jaccard")
PCoA_uu_noH2O <- ordinate(psdata_OBER_rare_noH2O, method = "PCoA", distance = "uunifrac")
PCoA_wu_noH2O <- ordinate(psdata_OBER_rare_noH2O, method = "PCoA", distance = "wunifrac")

colnames(sample_data(psdata_OBER_rare_noH2O))
plot_PCoA_BC_noH2O <- plot_ordination(physeq = psdata_OBER_rare_noH2O, 
                                ordination = PCoA_BC_noH2O, 
                                type = "samples", axes = c(1,2), color = "combined", shape = "Protocol") + ggtitle("BC - Granules only") + theme_classic()
plot_PCoA_Jac_noH2O <- plot_ordination(physeq = psdata_OBER_rare_noH2O, 
                                 ordination = PCoA_Jac_noH2O, 
                                 type = "samples", axes = c(1,2), color = "combined", shape = "Protocol") + ggtitle("Jaccard - Granules only") + theme_classic()
plot_PCoA_uu_noH2O <- plot_ordination(physeq = psdata_OBER_rare_noH2O, 
                                ordination = PCoA_uu_noH2O, 
                                type = "samples", axes = c(1,2), color = "combined", shape = "Protocol") + ggtitle("unweighted UniFrac - Granules only") + theme_classic()
plot_PCoA_wu_noH2O <- plot_ordination(physeq = psdata_OBER_rare_noH2O, 
                                ordination = PCoA_wu_noH2O, 
                                type = "samples", axes = c(1,2), color = "combined", shape = "Protocol") + ggtitle("weighted UniFrac - Granules only") + theme_classic()

beta_plot = cowplot::plot_grid(plot_PCoA_Jac_noH2O, plot_PCoA_BC_noH2O, plot_PCoA_uu_noH2O, plot_PCoA_wu_noH2O, nrow=2, ncol=2)
beta_plot 

pdf("figures/Fig_S3_plot_beta_diversity_OBER_proj1_BODAC_Granules_only_rare16865.pdf", useDingbats = F, width = 10, height = 5)
beta_plot
dev.off()

```

Backwashing seems to affect the community composition of granule biofilm slightly, washing out particular bacterial lineages as the effects are most clear in weighted and unweighted UniFrac ordinations, and particularly in polishing filters.

```{r backwashing beta diversity stats, message=F, echo=T, eval=T, warning=T, include=T, cache=F}

dist_bc_noH2O <- distance(psdata_OBER_rare_noH2O , "bray")
dist_jac_noH2O <- distance(psdata_OBER_rare_noH2O, "jaccard", binary=T)
dist_uu_noH2O <- distance(psdata_OBER_rare_noH2O,  "uunifrac")
dist_wu_noH2O <- distance(psdata_OBER_rare_noH2O,  "wunifrac")


# test model assumptions with vegan::betadisper
metadata2_noH2O$dummy_betadisp_noH2O <- factor(paste0(metadata2_noH2O$Filter_type, "-",metadata2_noH2O$Time, "-", metadata2_noH2O$Protocol))

betadisper_jac_noH2O <- betadisper(dist_jac_noH2O,metadata2_noH2O$dummy_betadisp_noH2O)
anova(betadisper_jac_noH2O) %>% broom::tidy() %>% kableExtra::kbl(caption = "Dispersion Jaccard distance") %>% kableExtra::kable_minimal()     

betadisper_bc_noH2O <- betadisper(dist_bc_noH2O,metadata2_noH2O$dummy_betadisp_noH2O)
anova(betadisper_bc_noH2O) %>% broom::tidy() %>% kableExtra::kbl(caption = "Dispersion Bray-Curtis dissimilarity") %>% kableExtra::kable_minimal()                      

betadisper_uu_noH2O <- betadisper(dist_uu_noH2O,metadata2_noH2O$dummy_betadisp_noH2O)
anova(betadisper_uu_noH2O) %>% broom::tidy() %>% kableExtra::kbl(caption = "Dispersion unweighted UniFrac") %>% kableExtra::kable_minimal()

betadisper_wu_noH2O <- betadisper(dist_wu_noH2O,metadata2_noH2O$dummy_betadisp_noH2O)
anova(betadisper_wu_noH2O) %>% broom::tidy() %>% kableExtra::kbl(caption = "Dispersion weighted UniFrac") %>% kableExtra::kable_minimal()


## for all four beta diversity metrics no significant group differences were found in group dispersions (distance to centroid).

# PERMANOVA (permutational multivariate analysis of variance) with the 'adonis' function

adonis_jac_noH2O <- adonis2(dist_jac_noH2O ~ Filter_type + Time , permutations = 999, data = metadata2_noH2O, by = "margin")
adonis_jac_noH2O %>% broom::tidy() %>% kableExtra::kbl(caption = "Jaccard distance") %>% kableExtra::kable_minimal()

adonis_bc_noH2O <- adonis2(dist_bc_noH2O ~ Filter_type + Time , permutations = 999, data = metadata2_noH2O, by = "margin")
adonis_bc_noH2O %>% broom::tidy() %>% kableExtra::kbl(caption = "Bray-Curtis dissimilarity") %>% kableExtra::kable_minimal()                 

adonis_uu_noH2O <- adonis2(dist_uu_noH2O ~ Filter_type + Time , permutations = 999, data = metadata2_noH2O, by = "margin")
adonis_uu_noH2O %>% broom::tidy() %>% kableExtra::kbl(caption = "unweighted UniFrac") %>% kableExtra::kable_minimal()

adonis_wu_noH2O <- adonis2(dist_wu_noH2O ~ Filter_type + Time , permutations = 999, data = metadata2_noH2O, by = "margin")
adonis_wu_noH2O %>% broom::tidy() %>% kableExtra::kbl(caption = "weighted UniFrac") %>% kableExtra::kable_minimal()


```


#### Venn diagramm for co-occurrence and co-exclusion patterns

```{r venn diagram, message=F, echo=T, eval=T, warning=T, include=T, cache=F, fig.height=14, fig.width=7}

# from https://rdrr.io/github/Russel88/MicEco/man/ps_venn.html
source("scripts/ps_venn.r")

psdata_OBER_rare_noPolFilAftBackw <- subset_samples(psdata_OBER_rare, combined != "Polishing_filter-Granules-After")
psdata_OBER_rare_0.01 <- prune_taxa(taxa_sums(psdata_OBER_rare) > 0.0001, psdata_OBER_rare)
psdata_OBER_rare_noPolFilAftBackw_0.01 <- prune_taxa(taxa_sums(psdata_OBER_rare_noPolFilAftBackw) > 0.0001, psdata_OBER_rare_noPolFilAftBackw)
psdata_OBER_rare_noPolFilAftBackw_0.1 <- prune_taxa(taxa_sums(psdata_OBER_rare_noPolFilAftBackw) > 0.001, psdata_OBER_rare_noPolFilAftBackw)
psdata_OBER_rare_noPolFilAftBackw_0.5 <- prune_taxa(taxa_sums(psdata_OBER_rare_noPolFilAftBackw) > 0.005, psdata_OBER_rare_noPolFilAftBackw)

mean(sample_sums(psdata_OBER_rare_noPolFilAftBackw))
mean(sample_sums(psdata_OBER_rare_noPolFilAftBackw_0.01))
mean(sample_sums(psdata_OBER_rare_noPolFilAftBackw_0.1))
mean(sample_sums(psdata_OBER_rare_noPolFilAftBackw_0.5))

ntaxa(psdata_OBER_rare_noPolFilAftBackw)
ntaxa(psdata_OBER_rare_noPolFilAftBackw_0.01)
ntaxa(psdata_OBER_rare_noPolFilAftBackw_0.1)
ntaxa(psdata_OBER_rare_noPolFilAftBackw_0.5)




# plot rankabundance
source("scripts/amp_rankabundance.r")
#devtools::source_gist("8d0ca4206a66be7ff6d76fc4ab8e66c6")

# #go convert --> STILL TO WORK ON
# sample_data(psdata_OBER_rare_noPolFilAftBackw)$'Sample ID' <- sample_names(psdata_OBER_rare_noPolFilAftBackw)
# ncol(sample_data(psdata_OBER_rare_noPolFilAftBackw))
# colnames(sample_data(psdata_OBER_rare_noPolFilAftBackw))
# sample_data(psdata_OBER_rare_noPolFilAftBackw)[,c(13, 1:11)]
# ampvis2_obj <- phyloseq_to_ampvis2(psdata_OBER_rare_noPolFilAftBackw)
# amp_rankabundance(ampvis2_obj, group_by = "combined", showSD = TRUE, log10_x = F)


venn_count_0.01 <-         
ps_venn(ps = psdata_OBER_rare_noPolFilAftBackw_0.01, 
        group = 'Protocol', 
        fraction = 0,
        weight = F,
        type = "percent",
        rareative = F,
        plot = T)

venn_count_0.01_count <-         
ps_venn(ps = psdata_OBER_rare_noPolFilAftBackw_0.01, 
        group = 'Protocol', 
        fraction = 0,
        weight = F,
        type = "counts",
        rareative = F,
        plot = T)

venn_count_0.01_genus <-         
ps_venn(ps = tax_glom(psdata_OBER_rare_noPolFilAftBackw_0.01, "Genus"), 
        group = 'Protocol', 
        fraction = 0,
        weight = F,
        type = "percent",
        rareative = F,
        plot = T)

ps_granule <- subset_samples(psdata_OBER_rare_0.01, Sample_type == "Granules")
ps_granule_FS <- subset_samples(ps_granule, Protocol == "Fast_DNA")
ps_granule_pre <- prune_taxa(taxa_sums(subset_samples(ps_granule_FS, Filter_type == "Pre-filter")) > 0, subset_samples(ps_granule_FS, Filter_type == "Pre-filter"))
ps_granule_polish <-  prune_taxa(taxa_sums(subset_samples(ps_granule_FS, Filter_type == "Polishing_filter")) > 0, subset_samples(ps_granule_FS, Filter_type == "Polishing_filter"))
                                    

venn_count_0.01_Time_pre <-         
ps_venn(ps = ps_granule_pre, 
        group = 'Time', 
        fraction = 0,
        weight = F,
        type = "percent",
        rareative = F,
        plot = T)

venn_count_0.01_Time_polish <-         
ps_venn(ps = ps_granule_polish, 
        group = 'Time', 
        fraction = 0,
        weight = F,
        type = "percent",
        rareative = F,
        plot = T)

pdf("figures/plot_venn_diagram_OBER_proj1_BODAC_Protocols_none_0.001_0.01_0.5pct.pdf", useDingbats = F, width = 7, height = 13)
gridExtra::grid.arrange(venn_count_0.01_Time_pre, venn_count_0.01_Time_polish, nrow=2, ncol=1)
dev.off()   

```

Playing around with taxon abundance thresholds range (0.001, 0.01, 0.1, 0.5, 1 % of total abundance) shows that the CTAB and FastSpin kit protocols detect unique taxa (ASV level) in the rare biosphere (>0.5%). At 1% thresholds, both methods detect the same core community.


```{r rel abund barplot, eval=T, echo=T, message=FALSE, warning=TRUE, cache=FALSE, include=T}

# set colorset
colorset <- c("darkblue", "darkgoldenrod1", "darkseagreen", "darkorchid", "darkolivegreen1", "lightskyblue", "darkgreen",  "khaki2", "firebrick", "brown1", "darkorange1", "cyan1", "royalblue4", "darksalmon", "darkblue", "royalblue4", "dodgerblue3", "steelblue1", "lightskyblue", "darkseagreen", "darkgoldenrod1", "darkseagreen", "darkorchid", "darkolivegreen1", "brown1", "darkorange1", "cyan1", "darkgrey", "darkblue", "darkgoldenrod1", "darkseagreen", "darkorchid", "darkolivegreen1", "lightskyblue", "darkgreen", "deeppink", "khaki2", "firebrick", "brown1", "darkorange1", "cyan1", "royalblue4", "darksalmon", "darkblue", "royalblue4", "dodgerblue3", "steelblue1", "lightskyblue", "darkseagreen", "darkgoldenrod1", "darkseagreen", "darkorchid", "darkolivegreen1", "brown1", "darkorange1", "cyan1", "darkgrey")


#input data
ps_Genus_rare <- psmelt(transform_sample_counts(tax_glom(psdata_OBER_rare, "Genus"), fun = function(x) x/sum(x)))

Genus_abundances <- ps_Genus_rare %>% 
  as_tibble() %>% 
  select(Sample, Sample_type, Filter_type, Protocol, Time, combined, Genus, Abundance) %>% 
  mutate(combined = as.character(combined)) %>% 
  group_by(Sample, combined, Genus) %>% 
  summarize(rel_abund = sum(Abundance), .groups = "drop") %>% 
  group_by(combined, Genus) %>% 
  summarize(mean_rel_abund = 100* mean(rel_abund), .groups = "drop") %>% 
  mutate(Family = if_else(Family == "uncultured", paste0("Family in ", Order), Family)) %>% 
  mutate(Genus = if_else(Genus == "Family_uncultured", paste0("Genus in ", Order), Genus)) %>%
  mutate(Genus = str_replace(Genus, "(.*)_unclassified", "Unclassified *\\1*"),
         Genus = str_replace(Genus, "uncultured$", "Unclassified bacterium"),
         Genus = str_replace(Genus, "^(\\S*)$", "*\\1*"))

Genus_abundances_granules <- ps_Genus_rare %>% 
  as_tibble() %>% 
  select(Sample, Sample_type, Filter_type, Protocol, Time, combined, Genus, Abundance) %>% 
  mutate(combined = as.character(combined)) %>% 
  group_by(Sample, Sample_type, Protocol, combined, Genus) %>% 
  filter(Sample_type == "Granules") %>% 
  summarize(rel_abund = sum(Abundance), .groups = "drop") %>% 
  group_by(combined, Protocol, Genus) %>% 
  summarize(mean_rel_abund = 100* mean(rel_abund), .groups = "drop") %>% 
  mutate(Family = if_else(Family == "uncultured", paste0("Family in ", Order), Family)) %>% 
  mutate(Genus = if_else(Genus == "Family_uncultured", paste0("Genus in ", Order), Genus)) %>%
  mutate(Genus = str_replace(Genus, "(.*)_unclassified", "Unclassified *\\1*"),
         Genus = str_replace(Genus, "uncultured$", "Unclassified bacterium"),
         Genus = str_replace(Genus, "^(\\S*)$", "*\\1*"))

Genus_abundances_BW <- ps_Genus_rare %>% 
  as_tibble() %>% 
  select(Sample, Sample_type, Filter_type, Protocol, Time, combined, Genus, Abundance) %>% 
  mutate(combined = as.character(combined)) %>% 
  group_by(Sample, Sample_type, Protocol, combined, Genus) %>% 
  filter(Sample_type == "Water") %>% 
  summarize(rel_abund = sum(Abundance), .groups = "drop") %>% 
  group_by(combined, Protocol, Genus) %>% 
  summarize(mean_rel_abund = 100* mean(rel_abund), .groups = "drop") %>% 
  mutate(Family = if_else(Family == "uncultured", paste0("Family in ", Order), Family)) %>% 
  mutate(Genus = if_else(Genus == "Family_uncultured", paste0("Genus in ", Order), Genus)) %>%
  mutate(Genus = str_replace(Genus, "(.*)_unclassified", "Unclassified *\\1*"),
         Genus = str_replace(Genus, "uncultured$", "Unclassified bacterium"),
         Genus = str_replace(Genus, "^(\\S*)$", "*\\1*"))

Genus_pool <- Genus_abundances %>% 
  group_by(Genus) %>% 
  summarize(pool = max(mean_rel_abund) < 5, 
            mean = mean(mean_rel_abund), 
            .groups = "drop") 

Genus_pool_granules <- Genus_abundances_granules %>% 
  group_by(Genus) %>% 
  summarize(pool = max(mean_rel_abund) < 3, 
            mean = mean(mean_rel_abund), 
            .groups = "drop") 
  
Genus_pool_BW <- Genus_abundances_BW %>% 
  group_by(Genus) %>% 
  summarize(pool = max(mean_rel_abund) < 2, 
            mean = mean(mean_rel_abund), 
            .groups = "drop") 

library(RColorBrewer)

# barplot granules only
barplot_granules <-
inner_join(Genus_abundances_granules, Genus_pool_granules, by="Genus") %>% 
  mutate(Genus = if_else(pool, "Other (< 3%)", Genus)) %>% 
  group_by(combined, Protocol, Genus) %>%
  summarize(mean_rel_abund = sum(mean_rel_abund), 
            mean = min(mean),
            .groups = "drop") %>% 
  mutate(Genus = factor(Genus), 
         Genus = fct_reorder(Genus, mean, .desc = T),
         Genus = fct_shift(Genus, n=1)) %>% 
ggplot(aes(x=combined, y = mean_rel_abund, fill = Genus)) +
  geom_col() +
  scale_y_continuous(expand = c(0,0)) +
  labs(x=NULL, y="Mean Relative Abundance (%)") +
  scale_fill_manual(name="Genus",
                    values = c(rev(brewer.pal(6, "Dark2")), rev(brewer.pal(8, "Paired")), colorset)) +
  theme_classic() +
  theme(axis.text.x = element_markdown(),
        legend.text = element_markdown(),
        legend.key.size = unit(10, "pt")) +
  facet_wrap(~Protocol, nrow = 2) +
  coord_flip()

# barplot backwash water only
BW_barplot <- 
inner_join(Genus_abundances_BW, Genus_pool_BW, by="Genus") %>% 
  mutate(Genus = if_else(pool, "Other (< 2%)", Genus)) %>% 
  group_by(combined, Protocol, Genus) %>%
  summarize(mean_rel_abund = sum(mean_rel_abund), 
            mean = min(mean),
            .groups = "drop") %>% 
  mutate(Genus = factor(Genus), 
         Genus = fct_reorder(Genus, mean, .desc = T),
         Genus = fct_shift(Genus, n=1)) %>% 
ggplot(aes(x=combined, y = mean_rel_abund, fill = Genus)) +
  geom_col() +
  scale_y_continuous(expand = c(0,0)) +
  labs(x=NULL, y="Mean Relative Abundance (%)") +
  facet_wrap(~Protocol, nrow = 2) +
  scale_fill_manual(name="Genus",
                    values = c(rev(brewer.pal(6, "Dark2")), rev(brewer.pal(8, "Paired")), colorset)) +
  theme_classic() +
  theme(axis.text.x = element_markdown(),
        legend.text = element_markdown(),
        legend.key.size = unit(10, "pt")) +
  coord_flip()




bars = plot_grid(barplot_granules, BW_barplot, labels = c("A", "B"), align = "hv", nrow = 2, rel_heights = c(2, 1.3))
ggsave(bars, filename = "figures/plot_barplots_genus_OBER_rare16865.pdf", width = 8, height = 8)
bars


```
Fig. x. Relative abundance of genus-level taxonomic groups based on 16S rRNA gene copies. (add n per bar in axis text)


```{r sample_wise rel abund barplot, eval=T, echo=T, message=FALSE, warning=TRUE, cache=FALSE, include=T}

Genus_abundances_sample <- ps_Genus_rare %>% 
  as_tibble() %>% 
  select(Sample, Sample_type, Filter_type, Protocol, Time, combined, Genus, Abundance) %>% 
  mutate(combined = as.character(combined)) %>% 
  group_by(Protocol, Sample_type, Filter_type, Sample, combined, Genus) %>% 
  summarize(rel_abund = sum(Abundance), .groups = "drop") %>% 
  group_by(Protocol, Sample_type, Filter_type, Sample, combined, Genus) %>% 
  summarize(mean_rel_abund = 100* mean(rel_abund), .groups = "drop") %>% 
  mutate(Genus = str_replace(Genus, "(.*)_unclassified", "Unclassified *\\1*"),
         Genus = str_replace(Genus, "uncultured$", "Unclassified bacterium"),
         Genus = str_replace(Genus, "^(\\S*)$", "*\\1*"))


Genus_pool_sample <- Genus_abundances_sample %>% 
  group_by(Sample, Sample_type, Filter_type, combined, Protocol, Genus) %>% 
  summarize(mean = mean(mean_rel_abund), .groups = "drop") %>% 
  group_by(Genus) %>% 
  summarize(pool = max(mean) < 5, 
            mean = mean(mean), 
            .groups = "drop") 
  
sample_order <- Genus_abundances_sample %>% 
  filter(Genus ==  "*Nitrospira*") %>% 
  arrange(desc(mean_rel_abund)) %>% 
  mutate(order = 1:nrow(.)) %>% 
  select(Sample, order)


inner_join(Genus_abundances_sample, Genus_pool_sample, by="Genus") %>% 
  mutate(Genus = if_else(pool, "Other (< 5%)", Genus)) %>% 
  group_by(Protocol, Sample, Sample_type, Filter_type, combined, Genus) %>%
  summarize(rel_abund = sum(mean_rel_abund), 
            mean = min(mean),
            .groups = "drop") %>% 
  mutate(Genus = factor(Genus), 
         Genus = fct_reorder(Genus, mean, .desc = T),
         Genus = fct_shift(Genus, n=1)) %>% 
  inner_join(., sample_order, by = "Sample") %>% 
  mutate(Sample = factor(Sample),
         Sample = fct_reorder(Sample, order), 
         Filter_type = fct_relevel(Filter_type, "Pre-filter")) %>% 
ggplot(aes(x=Sample, y = rel_abund, fill = Genus)) +
  geom_col(width = 1) +
  scale_fill_manual(name="Genus",
                    values = colorset) +
                        # breaks = c("*Geobacter*",
                        #            "*Dysgonomonas*",
                        #            "*Dechlorosoma*",
                        #            "*Leptolinea*",
                        #            "*Proteiniphilum*",
                        #            "*Petrimonas*",
                        #            "*Family_PHOS-HE36*",
                        #            "Unclassified bacterium",
                        #            "Other (< 5%)"),
                        # values = c(brewer.pal(8,"Paired"),"grey")) + # with palette
                        # #values = colorset) +
  scale_y_continuous(expand = c(0,0)) +
  facet_grid(~Sample_type+Protocol+Filter_type, space = "free", scales = "free_x", switch = "x") +
  labs(x=NULL, y="Mean Relative Abundance (%)") +
  guides(fill = guide_legend(nrow = 3, byrow = F)) +
  theme_classic() +
  theme(axis.text.x = element_blank(),
        legend.text = element_markdown(),
        legend.key.size = unit(7, "pt"),
        axis.ticks.x = element_blank(), 
        strip.background = element_blank(),
        strip.placement = "outside",
        legend.position = "bottom")

ggsave("figures/OBER_stacked_barplot_Genus_samplewise_.pdf", width = 7, height = 4, units = "in") 



```


```{r TODO -ANCOM-BC, eval=F, echo=F, include=F}

# install and load ANCOM-BC

# input data = ps_unfiltered
psdata_bodac1 = psdata_OBER %>% 
  subset_samples(Filter_type == "Pre-filter") %>% 
  prune_taxa(taxa_sums(.)>0, .)

# number of ASVs in bodac1 data
ntaxa(psdata_bodac1)

# run ANCOM-BC on ASV level
out = ancombc(phyloseq = psdata_bodac1, group = "Protocol" 
              ,formula = "Protocol", 
              p_adj_method = "fdr", zero_cut = 0.9, lib_cut = 0, 
              struc_zero = TRUE, neg_lb = TRUE, tol = 1e-5, 
              max_iter = 100, conserve = TRUE, alpha = 0.05, 
              global = TRUE)

data_DA <-purrr::map_dfc(out$res, bind_cols) %>% 
  rename_with(~names(out$res)) %>% 
  as_tibble(rownames = "taxon_name")

# significantly abundant (fdr < 0.05) taxa              
out$res$diff_abn %>% filter(ProtocolFast_DNA) %>% 
  mutate(taxon_name = row.names(.)) %>% 
  select(taxon_name, everything()) %>% 
  as_tibble()

# plot volcano plot of differentially abundant taxa
plot_DA <- 
 data_DA %>% 
  # filter(q_val < 0.05) # filter only significant taxa
  ggplot(aes(x = beta, y=-log10(q_val))) +
  geom_point(aes(color = if_else(q_val < 0.05, "red", "grey30"), 
                 alpha = if_else(q_val < 0.05, 1, 0.3)),
             show.legend = F) +
  labs(x =  "Effect size beta", y = "significance (-log10(q))") +
  coord_trans(y = "log10", expand = T) +
  scale_color_manual(values = c("grey10", "red")) +
  theme_classic() +
  theme()

plot_DA 

# summarize ancom results

taxa_list_bodac1 = data.frame(tax_table(psdata_bodac1)) %>% 
  mutate(taxon_name = taxa_names(psdata_bodac1)) %>% 
  select(taxon_name, everything()) %>% 
  as_tibble()

# table of significantly different taxa (global)
diff_abund_bodac1 <- inner_join(data_DA, taxa_list_bodac1, by = "taxon_name") %>% 
  select(-diff_abn) %>% 
  arrange(desc(W))

# save differentially abundant taxa
diff_abund_bodac1 %>% 
  write_excel_csv(file = "output_data/Table_Sx_ANCOM-BC_ASV_level.csv")


```

```{r TODO heatmap diff abund ANCOM-BC, eval=F, echo=F, include=F}

# create centered log ratio transformed OTU table
ps_clr <- microbiome::transform(psdata_bodac1, transform = "clr")
### Heatmap differential abundant taxa ANCOM-BC
ps_diff_abund_bodac1 <- subset_taxa(ps_clr, taxa_names(ps_clr) %in% diff_abund_bodac1$taxon_name)

# ComplexHeatmap metadata

matrix <- as.matrix(data.frame(otu_table(ps_diff_abund_bodac1)))
rownames(matrix) <- as.character(tax_table(ps_diff_abund_bodac1)[, "Species"])
metadata_sub <- data.frame(sample_data(ps_diff_abund_bodac1))
metadata_sub = metadata_sub %>% mutate(Time = if_else(is.na(Time), "After", Time))
# Define the annotation color for columns and rows
annotation_col = data.frame(
    Protocol = as.factor(metadata_sub$Protocol), 
    Sample_type = as.factor(metadata_sub$Sample_type), 
    Time = as.factor(metadata_sub$Time),
    check.names = FALSE)
rownames(annotation_col) = rownames(metadata_sub)

annotation_row = data.frame(
    Phylum = as.factor(tax_table(ps_diff_abund_bodac1)[, "Phylum"])
)
rownames(annotation_row) = NULL

# ann_color should be named vectors
colorset = c(RColorBrewer::brewer.pal(8, "Dark2"), RColorBrewer::brewer.pal(8, "Paired"), colorset)
phylum_col = colorset[1:length(levels(annotation_row$Phylum))]
names(phylum_col) = levels(annotation_row$Phylum)

ann_colors = list(
    Protocol = c(`CTAB_method` = "#1B9E77", 
                `Fast_DNA` = "#D95F02"),
    Sample_type = c(`Water` = "#0065AA",
                  `Granules` = "#94DD68"),
    Time = c(`Before` = "#FF5C00",
             `After` = "#FFAE47"),
    Phylum = phylum_col)
 

pdf("figures/Heatmap_differential_abundant_ASVs_ANCOM-BC_Population_GenusTags.pdf", width = 8, height = 8, useDingbats = F)
ComplexHeatmap::pheatmap(matrix, 
                         scale= "row", 
                         annotation_col = annotation_col, 
                         annotation_row = annotation_row, 
                         annotation_colors = ann_colors)
dev.off()


```

